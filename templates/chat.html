<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{{ title }}</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-[#121212] text-gray-100 font-sans p-6 space-y-4">
    <div class="flex justify-between items-center p-4">
        <p>Logged in as <b>{{ logged_in_as }}</b> in room "{{ room_name }}" (#{{ room_id }})</p>
        <form action="/account/logout" method="post">
            <button
                type="submit"
                class="text-sm text-purple-400 hover:text-purple-300 hover:underline"
            >
                Logout
            </button>
        </form>
    </div>

    <div class="flex space-x-2">
        <input
            id="message_text_input"
            placeholder="Type a message..."
            class="flex-grow px-3 py-2 rounded bg-[#1e1e1e] text-gray-100 border border-gray-700 focus:outline-none focus:ring focus:ring-purple-600"
        />
    </div>

    <ul id="messages" class="space-y-2"></ul>

    <script id="initial-messages" type="application/json">
        {{ initial_messages_json | safe }}
    </script>

    <script>
        class ChatMessage {
            constructor(data) {
                this.id = data.id;
                this.senderUsername = data.sender_username;
                this.senderId = data.sender_id;
                this.roomId = data.room_id;
                this.text = data.text;
                this.sentAt = data.sent_at;
            }

            render() {
                const li = document.createElement("li");
                li.className = "bg-[#1e1e1e] p-3 rounded border border-gray-700";

                const time = new Date(this.sentAt).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                li.innerHTML = `
                    <div class="text-sm text-purple-400">${this.senderUsername} <span class="text-gray-500 text-xs">${time}</span></div>
                    <div>${this.text}</div>
                `;
                return li;
            }
        }
    </script>

    <script>
        const websocket = new WebSocket("ws://" + location.host + "/chat/{{ room_id }}/websocket");
        const chat = document.getElementById("messages");
        const input = document.getElementById("message_text_input");

        const initial = JSON.parse(document.getElementById("initial-messages").textContent);
        initial.forEach(msg => {
            const message = new ChatMessage(msg);
            chat.prepend(message.render());
        });

        websocket.onmessage = (event) => {
            const message = new ChatMessage(JSON.parse(event.data));
            chat.prepend(message.render());
        };

        input.addEventListener("keydown", event => {
            if (event.key === "Enter" && input.value) {
                const payload = JSON.stringify({
                    room_id: {{ room_id }},
                    text: input.value
                });
                websocket.send(payload);
                input.value = "";
            }
        });
    </script>
</body>
</html>
