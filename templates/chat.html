<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{{ title }}</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-[#121212] text-gray-100 font-sans p-6 space-y-4">
    <div class="flex justify-between items-center p-4">
        <p>Logged in as <b>{{ logged_in_as }}</b> in room "{{ room_name }}" (#{{ room_id }})</p>

        <form
            id="upload-form"
            action="/upload"
            method="POST"
            enctype="multipart/form-data"
            class="flex space-x-2 bg-[#1e1e1e] p-2 rounded"
        >
            <input
                type="file"
                name="file"
                class="text-sm text-gray-100"
                required
            />
            <input type="hidden" name="room_id" value="{{ room_id }}">
            <button
                type="submit"
                class="text-sm text-purple-400 hover:text-purple-300 hover:underline"
            >
                Upload file
            </button>
        </form>

        <form action="/account/logout" method="post">
            <button
                type="submit"
                class="text-sm text-purple-400 hover:text-purple-300 hover:underline"
            >
                Logout
            </button>
        </form>
    </div>

    <div class="flex space-x-2">
        <input
            id="message_text_input"
            placeholder="Type a message..."
            class="flex-grow px-3 py-2 rounded bg-[#1e1e1e] text-gray-100 border border-gray-700 focus:outline-none focus:ring focus:ring-purple-600"
        />
    </div>

    <ul id="messages" class="space-y-2"></ul>

    <script id="initial-messages" type="application/json">
        {{ initial_messages_json | safe }}
    </script>

    <script>
        class ChatMessage {
            constructor(data) {
                this.id = data.id;
                this.sender = data.sender;
                this.roomId = data.room_id;
                this.text = data.text;
                this.sentAt = new Date(data.sent_at);
                this.uploadFilename = data.upload_filename;
                this.uploadUrl = data.upload_url;
            }

            render() {
                const messageContainer = document.createElement('div');
                messageContainer.classList.add(
                    'bg-[#1e1e1e]', 'p-2', 'rounded-lg', 'mb-4', 'border', 'border-gray-700', 'shadow-md'
                );

                const senderInfo = document.createElement('div');
                senderInfo.classList.add('flex', 'items-center', 'text-sm', 'text-purple-400', 'mb-2');
                senderInfo.innerHTML
                    = `<b>${this.sender}</b>&nbsp;-&nbsp;<span class="text-xs">${this.sentAt.toLocaleString()}</span>`;
                messageContainer.appendChild(senderInfo);

                if (this.text) {
                    const textMessage = document.createElement('p');
                    textMessage.classList.add('text-gray-100', 'whitespace-pre-wrap');
                    textMessage.textContent = this.text;
                    messageContainer.appendChild(textMessage);
                }

                if (this.uploadUrl && this.uploadFilename) {
                    const fileLink = document.createElement('a');
                    fileLink.href = `/upload/${this.uploadUrl}`;
                    fileLink.download = this.uploadFilename;
                    fileLink.classList.add('text-blue-400', 'hover:text-blue-300', 'underline', 'mt-2', 'block');
                    fileLink.textContent = `Download ${this.uploadFilename}`;
                    messageContainer.appendChild(fileLink);
                }

                return messageContainer;
            }
        }
    </script>

    <script>
        const websocket = new WebSocket("ws://" + location.host + "/chat/{{ room_id }}/websocket");
        const chat = document.getElementById("messages");
        const input = document.getElementById("message_text_input");

        const initial = JSON.parse(document.getElementById("initial-messages").textContent);
        initial.forEach(msg => {
            const message = new ChatMessage(msg);
            chat.prepend(message.render());
        });

        websocket.onmessage = (event) => {
            const message = new ChatMessage(JSON.parse(event.data));
            chat.prepend(message.render());
        };

        input.addEventListener("keydown", event => {
            if (event.key === "Enter" && input.value) {
                const payload = JSON.stringify({
                    room_id: {{ room_id }},
                    text: input.value
                });
                websocket.send(payload);
                input.value = "";
            }
        });
    </script>
</body>
</html>
