<!DOCTYPE html>
<html lang="en" class="dark h-full">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>{{ title }}</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-[#121212] text-gray-100 font-nunito h-full">
    <div class="flex h-screen overflow-hidden" height="100%">
        <!-- NOTE: Sidebar for rooms -->
        <aside class="w-60 bg-[#1e1e1e] p-4 border-r border-gray-700 space-y-2 overflow-y-auto">
          <h2 class="text-lg text-purple-300">Your chat rooms</h2>
          <ul id="room-list" class="space-y-2"></ul>
        </aside>

        <!-- NOTE: Main chat area -->
        <main class="flex-grow px-4 py-4 overflow-y-auto">
            <div class="flex justify-between items-center pb-4">
                <p>Logged in as <b>{{ logged_in_as }}</b></p>

                <form
                    id="upload-form"
                    action="/upload"
                    method="POST"
                    enctype="multipart/form-data"
                    class="flex space-x-2 bg-[#1e1e1e] p-2 rounded"
                >
                    <input
                        type="file"
                        name="file"
                        class="text-sm text-gray-100"
                        required
                    />
                    <input type="hidden" name="room_id" value="{{ room_id }}">
                    <button
                        type="submit"
                        class="text-sm text-purple-400 hover:text-purple-300 hover:underline"
                    >
                        Upload file
                    </button>
                </form>

                <form action="/account/logout" method="post">
                    <button
                        type="submit"
                        class="text-sm text-purple-400 hover:text-purple-300 hover:underline"
                    >
                        Logout
                    </button>
                </form>
            </div>

            <div class="flex">
                <input
                    id="message_text_input"
                    placeholder="Type a message..."
                    class="flex-grow px-3 py-2 rounded bg-[#1e1e1e] text-gray-100 border border-gray-700 focus:outline-none focus:ring focus:ring-purple-600"
                />
            </div>

            <ul id="messages" class="pt-2 space-y-2"></ul>
        </main>
    </div>

    <script id="initial-messages" type="application/json">
        {{ initial_messages_json | safe }}
    </script>

    <script>
        class ChatMessage {
            constructor(data) {
                this.id = data.id;
                this.sender = data.sender;
                this.roomId = data.room_id;
                this.text = data.text;
                this.sentAt = new Date(data.sent_at);
                this.uploadFilename = data.upload_filename;
                this.uploadUrl = data.upload_url;
            }

            render() {
                const messageContainer = document.createElement('div');
                messageContainer.classList.add(
                    'bg-[#1e1e1e]', 'p-2', 'rounded-lg', 'border', 'border-gray-700', 'shadow-md'
                );

                const senderInfo = document.createElement('div');
                senderInfo.classList.add('flex', 'items-center', 'text-sm', 'text-purple-400', 'mb-2');
                senderInfo.innerHTML
                    = `<b>${this.sender}</b>&nbsp;-&nbsp;<span class="text-xs">${this.sentAt.toLocaleString()}</span>`;
                messageContainer.appendChild(senderInfo);

                if (this.text) {
                    const textMessage = document.createElement('p');
                    textMessage.classList.add('text-gray-100', 'whitespace-pre-wrap');
                    textMessage.textContent = this.text;
                    messageContainer.appendChild(textMessage);
                }

                if (this.uploadUrl && this.uploadFilename) {
                    const fileLink = document.createElement('a');
                    fileLink.href = `/upload/${this.uploadUrl}`;
                    fileLink.download = this.uploadFilename;
                    fileLink.classList.add('text-blue-400', 'hover:text-blue-300', 'underline', 'mt-2', 'block');
                    fileLink.textContent = `file: ${this.uploadFilename}`;
                    messageContainer.appendChild(fileLink);
                }

                return messageContainer;
            }
        }
    </script>

    <script>
        const websocket = new WebSocket("ws://" + location.host + "/chat/{{ room_id }}/websocket");
        const chat = document.getElementById("messages");
        const input = document.getElementById("message_text_input");

        const initial = JSON.parse(document.getElementById("initial-messages").textContent);
        initial.forEach(msg => {
            const message = new ChatMessage(msg);
            chat.prepend(message.render());
        });

        websocket.onmessage = (event) => {
            const message = new ChatMessage(JSON.parse(event.data));
            chat.prepend(message.render());
        };

        input.addEventListener("keydown", event => {
            if (event.key === "Enter" && input.value) {
                const payload = JSON.stringify({
                    room_id: {{ room_id }},
                    text: input.value
                });
                websocket.send(payload);
                input.value = "";
            }
        });
    </script>

    <script>
        async function loadRoomList() {
            try {
                const res = await fetch("/api/rooms");
                const rooms = await res.json();

                const list = document.getElementById("room-list");
                list.innerHTML = "";

                for (const room of rooms) {
                    const li = document.createElement("li");
                    const link = document.createElement("a");
                    link.href = `/chat/${room.room_id}`;
                    link.textContent = room.room_name;
                    link.classList.add("block", "text-purple-400", "hover:underline");
                    if (room.room_id === {{ room_id }}) {
                        link.classList.add("font-bold");
                        link.textContent = `> ${room.room_name}`;
                    }
                    li.appendChild(link);
                    list.appendChild(li);
                }
            } catch (err) {
                console.error("Failed to load rooms:", err);
            }
        }

        window.addEventListener("DOMContentLoaded", () => {
            loadRoomList();
        });
    </script>
</body>
</html>
